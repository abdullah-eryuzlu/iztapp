{% extends "panel/templates/global.njk" %}

{% block wrapper %}
<h1>{{ course.courseCode }} - {{ course.name }}</h1>

<hr>

<form action="/api/update/course/{{ course._id }}" method="POST" id="form-update">
	<div class="form-group">
		<label for="name">Course Name</label>
		<input type="text" class="form-control" id="name" name="name" value="{{ course.name }}"
			placeholder="Enter course name">
	</div>
	<div class="form-group">
		<label for="description">Course Description</label>
		<input type="text" class="form-control" id="description" name="description" value="{{ course.description }}"
			placeholder="Enter course description">
	</div>
	<div class="form-group">
		<label for="courseCode">Course Code</label>
		<input type="text" class="form-control" id="courseCode" name="courseCode" value="{{ course.courseCode }}"
			placeholder="Enter course courseCode">
	</div>
	<div class="form-group">
		<label>Course Prerequisites</label>
		{% set courseCounter = 0 %}
		{% for entity in courses %}
		<div class="form-check">
			<input class="form-check-input" type="checkbox" value="{{ entity._id }}" id="{{ entity.courseCode }}"
				name="precourse-{{ courseCounter }}" {% if entity._id in course.prerequisites %}checked{% endif %}>
			<label class="form-check-label" for="{{ entity.courseCode }}">
				{{ entity.courseCode }} - {{ entity.name }}
			</label>
		</div>
		{% set courseCounter = courseCounter + 1 %}
		{% endfor %}
	</div>
	<div class="form-group">
		<label for="departmentCode">Department Code</label>
		<input type="text" class="form-control" id="departmentCode" name="departmentCode"
			value="{{ course.departmentCode }}" placeholder="Enter course departmentCode">
	</div>
	<div class="form-group">
		<label for="topics">Course Topics</label>
		<input type="text" class="form-control" id="topics" name="topics" value="{{ course.topics }}"
			placeholder="Enter course topics" aria-describedby="topicDescribe">
		<small id="topicDescribe" class="form-text text-muted">Please seperate topics with comma (,).</small>
	</div>
	<div class="form-group">
		<label for="type">Course Type</label>
		<select class="form-control" id="type" name="type">
			{% for type in config.scheduleTypes %}
			{% if type == course.type %}
			<option value="{{ course.type }}" selected>{{ config.scheduleTypeStrings[course.type] }}</option>
			{% else %}
			<option value="{{ type }}">{{ config.scheduleTypeStrings[type] }}</option>
			{% endif %}
			{% endfor %}
		</select>
	</div>
	<div class="form-group">
		<label for="workers">Course Workers</label>
		<input type="text" class="form-control" id="workers" name="workers" value="{{ course.workers }}"
			placeholder="Enter course workers">
	</div>
	<div class="form-group">
		<label for="credits">Credits</label>
		<input type="text" class="form-control" id="credits" name="credits" value="{{ course.credits }}"
			placeholder="Enter course credits">
	</div>
	<div class="form-group">
		<label for="ects">ECTS</label>
		<input type="text" class="form-control" id="ects" name="ects" value="{{ course.ects }}"
			placeholder="Enter course ects">
	</div>
	<div class="form-group">
		<label for="lectureHours">Lecture Hours</label>
		<input type="text" class="form-control" id="lectureHours" name="lectureHours" value="{{ course.lectureHours }}"
			placeholder="Enter course lectureHours">
	</div>
	<div class="form-group">
		<label for="labHours">Lab Hours</label>
		<input type="text" class="form-control" id="labHours" name="labHours" value="{{ course.labHours }}"
			placeholder="Enter course labHours">
	</div>
	<button type="button" class="btn btn-primary btn-update">Update Course</button>
</form>
<hr>
<form action="/api/delete/course/{{ course._id }}" method="GET">
	<button type="submit" class="btn btn-danger">Delete</button>
</form>

{% endblock %}

{% block scripts %}
<script>
	function postData(url = ``, data) {
		// Default options are marked with *
		return fetch(url, {
			method: "POST", // *GET, POST, PUT, DELETE, etc.
			mode: "cors", // no-cors, cors, *same-origin
			cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
			credentials: "same-origin", // include, same-origin, *omit
			headers: {
				"Content-Type": "application/json; charset=utf-8",
				// "Content-Type": "application/x-www-form-urlencoded",
			},
			redirect: "follow", // manual, *follow, error
			referrer: "no-referrer", // no-referrer, *client
			body: JSON.stringify(data), // body data type must match "Content-Type" header
		})
			.then(response => response.json()); // parses response to JSON
	}
	$(".btn-update").on("click", (e) => {
		e.preventDefault();
		const formElement = document.getElementById("form-update");
		const data = {};
		let workers = [];
		let prerequisites = [];
		for (const pair of new FormData(formElement)) {
			if (pair[0].startsWith("precourse")) {
				prerequisites.push(pair[1]);
				continue;
			}
			if (pair[0].startsWith("worker")) {
				workers.push(pair[1]);
				continue;
			}
			data[pair[0]] = pair[1];
		}
		data.workers = workers;
		data.prerequisites = prerequisites;
		postData(`/api/update/course/{{ course._id }}`, data)
			.then(function (data) {
				if (data._id) {
					window.location.href = `/panel/courses/{{ course._id }}`
				}
			})
			.catch(error => console.error(error));
	});
</script>
{% endblock %}
